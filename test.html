<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>éCO₂mix — Consommation (widget ES5 v2.1)</title>
<style>
  :root{ --bg:#0b1222; --panel:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --brand:#60a5fa; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);display:flex;align-items:center;justify-content:center}
  .card{width:min(920px,95vw);padding:18px;background:var(--panel);border:1px solid #1f2b45;border-radius:16px}
  h1{font-size:18px;margin:0 0 8px;color:#dbeafe}
  .grid{display:grid;grid-template-columns:1fr 260px;gap:16px}
  .big{font-size:56px;line-height:1.05;margin:0}
  .unit{font-size:20px;color:#cbd5e1;margin-left:8px}
  .meta{color:var(--muted);font-size:13px;margin-top:6px}
  .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:#93c5fd;font-size:12px}
  .led{display:inline-flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:50%;background:#16a34a;box-shadow:0 0 10px rgba(22,163,74,.9);display:inline-block}
  .warn{background:#eab308;box-shadow:0 0 10px rgba(234,179,8,.9)}
  .src a{color:#93c5fd;text-decoration:none}
  .src a:hover{text-decoration:underline}
  #spark{width:100%;height:220px;background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 30%)}
  @media (max-width:720px){ .grid{grid-template-columns:1fr} .big{font-size:38px} #spark{height:160px} }
  .err{color:#fca5a5}
</style>
</head>
<body>
  <div class="card">
    <h1>Consommation d'électricité en France</h1>
    <div class="grid">
      <div>
        <p class="big"><span id="nowVal">—</span><span class="unit">MW</span></p>
        <div class="meta" id="nowWhen">Dernière mesure : —</div>
        <div class="meta" id="lagNote"></div>
      </div>
      <div>
        <svg id="spark" viewBox="0 0 600 220" preserveAspectRatio="none" aria-label="courbe 24h">
          <polyline id="sparkLine" fill="none" stroke="currentColor" stroke-width="2" points=""/>
          <g id="yTicks" stroke="rgba(148,163,184,.2)" stroke-width="1"></g>
        </svg>
      </div>
    </div>
    <div class="footer">
      <div class="led"><span class="dot" id="dot"></span><span id="status">Mise à jour…</span></div>
      <div class="src">Source : <a href="https://odre.opendatasoft.com/explore/dataset/eco2mix-national-tr/api/" target="_blank" rel="noopener">ODRÉ • éCO₂mix (RTE)</a></div>
    </div>
  </div>

<script>
(function(){
  // Explore v2.1 endpoints with explicit select/where/order to avoid empty sets.
  var BASES = [
    'https://odre.opendatasoft.com',
    'https://reseaux-energies-rte.opendatasoft.com'
  ];
  var PATH = '/api/explore/v2.1/catalog/datasets/eco2mix-national-tr/records';
  var QUERY = '?select=date_heure%2Cconsommation&where=perimetre%3D%22France%22%20and%20consommation%20is%20not%20null&order_by=date_heure%20desc&limit=96';
  var REFRESH_MS = 60000;
  var tz = 'Europe/Paris';
  var chartColor = '#60a5fa';

  function $(id){ return document.getElementById(id); }

  function setStatus(msg, warn){
    $('status').innerHTML = msg;
    var d = $('dot');
    if (warn) { d.className = 'dot warn'; } else { d.className = 'dot'; }
  }

  function xhrJson(url, ok, fail){
    try{
      var x = new XMLHttpRequest();
      x.onreadystatechange = function(){
        if (x.readyState === 4){
          if (x.status >= 200 && x.status < 300){
            try { ok(JSON.parse(x.responseText)); } catch(e){ fail(e); }
          } else {
            fail(new Error('HTTP '+x.status));
          }
        }
      };
      // Cache-busting to avoid CDN caching hiccups
      var bust = (url.indexOf('?')>-1 ? '&' : '?') + '_ts=' + Date.now();
      x.open('GET', url + bust, true);
      x.setRequestHeader('Accept','application/json');
      x.send();
    }catch(err){ fail(err); }
  }

  function toDate(obj){
    // v2.1 returns { date_heure: '2025-11-03T09:30:00+00:00' }
    var p = obj && (obj.date_heure || obj.dateheure || obj.date);
    return p ? new Date(p) : null;
  }

  function toConso(obj){
    return obj && obj.consommation != null ? Number(obj.consommation) : NaN;
  }

  function fmtDate(d){
    try{
      return d.toLocaleString('fr-FR', {timeZone: tz, hour:'2-digit', minute:'2-digit', day:'2-digit', month:'2-digit', year:'numeric'});
    }catch(e){
      return d.toLocaleString();
    }
  }

  function drawSpark(values){
    var w = 600, h = 220, pad = 8;
    var min = Infinity, max = -Infinity, i;
    for(i=0;i<values.length;i++){ if(values[i]<min) min=values[i]; if(values[i]>max) max=values[i]; }
    if (!isFinite(min) || !isFinite(max) || max===min){ $('sparkLine').setAttribute('points',''); return; }
    var pts = [];
    for(i=0;i<values.length;i++){
      var x = Math.round((i/(values.length-1))*(w-2*pad)+pad);
      var y = Math.round(h - pad - ((values[i]-min)/(max-min))*(h-2*pad));
      pts.push(x+','+y);
    }
    var line = $('sparkLine');
    line.setAttribute('points', pts.join(' '));
    line.setAttribute('stroke', chartColor);
    var g = $('yTicks'); while(g.firstChild) g.removeChild(g.firstChild);
    var t, steps = 4;
    for(i=0;i<=steps;i++){
      var yy = Math.round(h - pad - (i/steps)*(h-2*pad));
      t = document.createElementNS('http://www.w3.org/2000/svg','line');
      t.setAttribute('x1','0'); t.setAttribute('x2', String(w));
      t.setAttribute('y1', String(yy)); t.setAttribute('y2', String(yy));
      g.appendChild(t);
    }
  }

  function process(data){
    // v2.1 payload: { total_count, results: [ {date_heure, consommation}, ... ] }
    var recs = data && data.results ? data.results : [];
    var list = [];
    for (var i=0;i<recs.length;i++){
      var t = toDate(recs[i]);
      var y = toConso(recs[i]);
      if (t && isFinite(y)) list.push({t:t, y:y});
    }
    list.sort(function(a,b){ return a.t - b.t; });
    if (!list.length) throw new Error('Aucun point de donnée.');

    var last = list[list.length-1];
    $('nowVal').innerHTML = Math.round(last.y).toLocaleString('fr-FR');

    $('nowWhen').innerHTML = 'Dernière mesure : ' + fmtDate(last.t) + ' (pas 15 min)';
    var lagMin = Math.round((new Date().getTime() - last.t.getTime())/60000);
    $('lagNote').innerHTML = lagMin>30
      ? '⚠️ Donnée âgée de ~'+lagMin+' min (flux publié ~1×/h).'
      : 'Actualisation automatique chaque minute (flux publié ~1×/h).';
    setStatus('OK', lagMin>30);

    var vals = [];
    for (var j=Math.max(0, list.length-96); j<list.length; j++){ vals.push(list[j].y); }
    drawSpark(vals);
  }

  function load(){
    setStatus('Mise à jour…', false);
    // Try v2.1 on base[0], fallback to base[1], then fallback to v1 (records) if both fail
    xhrJson(BASES[0] + PATH + QUERY, function(d){ process(d); }, function(){
      xhrJson(BASES[1] + PATH + QUERY, function(d){ process(d); }, function(){
        // v1 fallback without refine to avoid empty sets
        var v1 = '/api/records/1.0/search/?dataset=eco2mix-national-tr&rows=120&sort=-date_heure';
        xhrJson(BASES[0] + v1, function(d){
          // Map v1 to v2-like objects
          var out = { results: [] };
          var recs = d && d.records ? d.records : [];
          for (var i=0;i<recs.length;i++){
            var f = recs[i].fields || {};
            if (f.perimetre === 'France' && f.consommation != null){
              out.results.push({ date_heure: f.date_heure || f.date || recs[i].record_timestamp, consommation: f.consommation });
            }
          }
          process(out);
        }, function(err){
          setStatus('Erreur de chargement', true);
          var e = document.createElement('div'); e.className='meta err'; e.innerHTML = String(err && err.message ? err.message : err);
          document.body.appendChild(e);
        });
      });
    });
  }

  load();
  setInterval(load, REFRESH_MS);
})();
</script>
</body>
</html>
